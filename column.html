<?php
session_start();

if (!isset($_SESSION['faculty_user'])) {
    header("Location: faculty_login.php");
    exit;
}


$db_host = "localhost";
$db_user = "root";
$db_pass = "";
$db_name = "room_allocation";

$conn = new mysqli($db_host, $db_user, $db_pass, $db_name);
if ($conn->connect_error) {
    die("<h2 style='color:red;'>Database connection failed: " . $conn->connect_error . "</h2>");
}

$faculty_email = $_SESSION['faculty_user'];

// Fetch faculty name
$stmt_name = $conn->prepare("SELECT faculty_name FROM faculty_assignments WHERE email_id = ? LIMIT 1");
$stmt_name->bind_param("s", $faculty_email);
$stmt_name->execute();
$result_name = $stmt_name->get_result();
$faculty_name = "Faculty";
if ($result_name->num_rows > 0) {
    $row_name = $result_name->fetch_assoc();
    $faculty_name = htmlspecialchars($row_name['faculty_name']);
}
$stmt_name->close();

// Fetch assigned duties
$stmt_duties = $conn->prepare("
    SELECT id, classroom_id, classroom, faculty_name, assigned_at, status 
    FROM faculty_assignments 
    WHERE email_id = ? 
    AND status != 'cancelled'
");
$stmt_duties->bind_param("s", $faculty_email);
$stmt_duties->execute();
$result_duties = $stmt_duties->get_result();

// Fetch total hours done
$stmt_hours = $conn->prepare("SELECT SUM(hours_of_duty_done) as total_hours FROM faculty_duty_done WHERE email_id = ?");
$stmt_hours->bind_param("s", $faculty_email);
$stmt_hours->execute();
$res_hours = $stmt_hours->get_result();
$row_hours = $res_hours->fetch_assoc();
$total_hours = $row_hours['total_hours'] ?? 0;
$stmt_hours->close();
?>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Invigilation Duties - <?php echo $faculty_name; ?></title>
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin:0; padding:0;
    background:#f5f7fa; color:#333;
}
.container { max-width:1200px; margin:50px auto; padding:20px; }
h1 { text-align:center; font-size:2.4em; color:#0d47a1; margin-bottom:10px; }
.hours-display { text-align:center; font-size:1.2em; margin-bottom:30px; color:#0d47a1; }
.cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:25px; }
.card {
    background:#fff; border-radius:12px; padding:25px;
    box-shadow:0 8px 20px rgba(0,0,0,0.1);
    transition:transform 0.3s, box-shadow 0.3s;
}
.card:hover { transform:translateY(-5px); box-shadow:0 15px 30px rgba(0,0,0,0.15); }
.card h2 { font-size:1.3em; color:#0d47a1; margin-bottom:12px; }
.card p { margin:8px 0; font-size:1em; color:#333; }
.card button { margin-right:10px; padding:8px 15px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
.ok-btn { background-color:#4CAF50; color:white; }
.cancel-btn { background-color:#f44336; color:white; }
.dashboard-btn {
    display:block; width:220px; margin:40px auto 0; padding:12px 0; text-align:center;
    background:#0d47a1; color:#fff; font-weight:bold; text-decoration:none; border-radius:8px;
    box-shadow:0 5px 15px rgba(0,0,0,0.2); transition:0.3s;
}
.dashboard-btn:hover { background:#08306b; transform:translateY(-2px); }
.no-duty { text-align:center; font-size:1.3em; margin-top:30px; color:#0d47a1; }

/* Modal Styles */
#cancelModal {
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;
}
#cancelModal .modal-content {
    background:#fff; padding:20px; border-radius:10px; width:400px; max-width:90%;
    box-shadow:0 5px 15px rgba(0,0,0,0.3);
}
#cancelModal textarea {
    width:100%; height:80px; padding:8px; border-radius:6px; border:1px solid #ccc;
}
#cancelModal h2 { margin-top:0; color:#0d47a1; }
#cancelModal button { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; }
#cancelModal .close-btn { background:#aaa; color:#fff; margin-right:10px; }
#cancelModal .submit-btn { background:#f44336; color:#fff; }
</style>
</head>
<body>
<div class="container">
    <h1>Invigilation Duties for <?php echo $faculty_name; ?></h1>
    <div class="hours-display">Total Hours Done: <span id="total-hours"><?php echo $total_hours; ?></span></div>

    <?php if ($result_duties->num_rows > 0): ?>
        <div class="cards">
            <?php while($row = $result_duties->fetch_assoc()): ?>
                <div class="card" id="duty-<?php echo $row['id']; ?>">
                    <h2>Classroom: <?php echo htmlspecialchars($row['classroom']); ?></h2>
                    <p><strong>Assigned At:</strong> <?php echo htmlspecialchars($row['assigned_at']); ?></p>
                    <p><strong>Duty ID:</strong> <?php echo htmlspecialchars($row['id']); ?></p>
                    <p><strong>Status:</strong> 
                        <?php 
                            $status = htmlspecialchars($row['status']);
                            if ($status === 'confirmed') {
                                echo "<span style='color:green;font-weight:bold;'>Confirmed ✅</span>";
                            } elseif ($status === 'pending') {
                                echo "<span style='color:orange;font-weight:bold;'>Pending ⏳</span>";
                            }
                        ?>
                    </p>

                    <?php if ($status === 'pending'): ?>
                        <button class="ok-btn" onclick="markDone(<?php echo $row['id']; ?>)">OK</button>
                        <button class="cancel-btn" onclick="cancelDuty(<?php echo $row['id']; ?>)">Cancel</button>
                    <?php endif; ?>
                </div>
            <?php endwhile; ?>
        </div>
    <?php else: ?>
        <div class="no-duty">No invigilation duties assigned yet.</div>
    <?php endif; ?>

    <a href="faculty_front_page.php" class="dashboard-btn">Return to Dashboard</a>
</div>

<!-- Cancel Duty Modal -->
<div id="cancelModal">
    <div class="modal-content">
        <h2>Cancel Duty</h2>
        <p>Please provide a reason for cancelling this duty:</p>
        <textarea id="cancelReason"></textarea>
        <div style="text-align:right; margin-top:15px;">
            <button class="close-btn" onclick="closeModal()">Close</button>
            <button class="submit-btn" id="submitCancelBtn">Submit</button>
        </div>
    </div>
</div>

<script>
let currentDutyId = null;

function updateHours(newHours) {
    document.getElementById('total-hours').innerText = newHours;
}

// Mark duty done
function markDone(dutyId) {
    if (!confirm("Confirm that this duty is done?")) return;

    fetch('update_duty.php', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'ok', duty_id:dutyId })
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.success) {
            alert("Assigned duty confirmed successfully!");
            const card = document.getElementById('duty-' + dutyId);
            card.style.backgroundColor = "#e0f7e9";
            card.innerHTML += `<p style="color:green;font-weight:bold;">Status: Confirmed ✅</p>`;
            card.querySelectorAll('button').forEach(btn => btn.disabled = true);
            updateHours(data.total_hours);
        } else alert(data.message);
    });
}

// Cancel modal logic
function cancelDuty(dutyId) {
    currentDutyId = dutyId;
    document.getElementById('cancelReason').value = '';
    document.getElementById('cancelModal').style.display = 'flex';
}
function closeModal() {
    document.getElementById('cancelModal').style.display = 'none';
}

// Submit cancel
document.getElementById('submitCancelBtn').addEventListener('click', function() {
    const reason = document.getElementById('cancelReason').value.trim();
    if(!reason) { alert("Please enter a reason."); return; }

    fetch('update_duty.php', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'cancel', duty_id:currentDutyId, reason:reason })
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.success) {
            alert("Duty cancelled successfully!");
            const card = document.getElementById('duty-' + currentDutyId);
            card.style.backgroundColor = "#f8d7da";
            card.innerHTML += `<p style="color:red;font-weight:bold;">Status: Cancelled ❌</p>`;
            card.querySelectorAll('button').forEach(btn => btn.disabled = true);
            updateHours(data.total_hours);
        } else alert(data.message);
        closeModal();
    });
});
</script>
</body>
</html>

<?php
$stmt_duties->close();
$conn->close();
?>
