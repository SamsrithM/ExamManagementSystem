<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Questions - Faculty Dashboard</title>
  <style>
    body { margin:0; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background-color:#f4f7f9; }
    form { background:white; padding:25px 30px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1); max-width:800px; margin:30px auto; display:flex; flex-direction:column; gap:15px; }
    .question-block { border:1px solid #ccc; padding:20px; border-radius:8px; background:#fafafa; position:relative; }
    label { display:block; font-weight:600; margin-bottom:5px; }
    input, textarea, select { width:100%; padding:10px; margin-bottom:10px; border:1px solid #ccc; border-radius:6px; }
    textarea { resize:vertical; }
    button { padding:12px 20px; font-size:1rem; background-color:#1abc9c; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:700; margin-top:10px; }
    button:hover { background-color:#159a85; }
    .delete-question-btn { position:absolute; top:15px; right:15px; background:#e74c3c; color:white; border:none; border-radius:4px; padding:5px 10px; cursor:pointer; }
    .delete-question-btn:hover { background:#c0392b; }
  </style>
</head>
<body>

  <form id="questionsForm">
    <button type="button" onclick="addQuestion()">+ Add First Question</button>
    <button type="submit">Publish Questions</button>
  </form>

  <script>
    let questionCount = 0;

    function addQuestion(){
      questionCount++;
      const form = document.getElementById('questionsForm');
      const block = document.createElement('div');
      block.className = 'question-block';
      block.dataset.id = questionCount;

      block.innerHTML = `
        <button type="button" class="delete-question-btn" onclick="deleteQuestion(${questionCount})">Delete</button>
        <label for="question${questionCount}">Question ${questionCount}</label>
        <textarea id="question${questionCount}" name="question${questionCount}" rows="3" required></textarea>

        <label for="type${questionCount}">Type</label>
        <select id="type${questionCount}" name="type${questionCount}" required onchange="toggleType(${questionCount})">
          <option value="" disabled selected>Select type</option>
          <option value="objective">Objective</option>
          <option value="descriptive">Descriptive</option>
        </select>

        <div id="options${questionCount}" style="display:none;">
          <label>Option A</label><input type="text" name="option${questionCount}_1" />
          <label>Option B</label><input type="text" name="option${questionCount}_2" />
          <label>Option C</label><input type="text" name="option${questionCount}_3" />
          <label>Option D</label><input type="text" name="option${questionCount}_4" />
          <label>Correct Answer</label>
          <select name="answer${questionCount}">
            <option value="" disabled selected>Select correct</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
          </select>
        </div>

        <div id="desc${questionCount}" style="display:none;">
          <label>Descriptive Answer</label>
          <textarea name="descAnswer${questionCount}" rows="3"></textarea>
        </div>
      `;
      form.insertBefore(block, form.querySelector('button[type="submit"]'));
    }

    function toggleType(id){
      const type = document.getElementById(`type${id}`).value;
      document.getElementById(`options${id}`).style.display = (type==='objective')?'block':'none';
      document.getElementById(`desc${id}`).style.display = (type==='descriptive')?'block':'none';
    }

    function deleteQuestion(id){
      const block = document.querySelector(`.question-block[data-id="${id}"]`);
      if(block) block.remove();
    }

    document.getElementById('questionsForm').addEventListener('submit', function(e){
      e.preventDefault();
      const test_id = localStorage.getItem('current_test_id');
      if(!test_id){ alert('Test ID not found.'); return; }

      const questions = [];
      document.querySelectorAll('.question-block').forEach(block=>{
        const qid = block.dataset.id;
        const questionText = block.querySelector(`#question${qid}`).value.trim();
        const type = block.querySelector(`#type${qid}`).value;
        const qData = {question: questionText, type:type};

        if(type==='objective'){
          const opts = [...block.querySelectorAll(`#options${qid} input`)].map(i=>i.value.trim());
          const ans = block.querySelector(`#options${qid} select`).value;
          qData.options = opts;
          qData.answer = ans;
        } else {
          const desc = block.querySelector(`#desc${qid} textarea`).value.trim();
          qData.descriptiveAnswer = desc;
        }
        questions.push(qData);
      });

      // âœ… Updated fetch URL to match your PHP file
      fetch('creating_test.php',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({test_id, questions})
      })
      .then(res=>res.json())
      .then(data=>{
        if(data.status==='success'){
          alert('Questions saved!');
          window.location.href='reviewquestions.html';
        } else alert('Error: '+data.message);
      })
      .catch(err=>alert('Error: '+err));
    });

    window.onload = addQuestion;
  </script>

</body>
</html>
