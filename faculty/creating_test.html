<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Questions - Faculty Dashboard</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f7f9;
    }
  
    header {
      background-color: #2c3e50;
      color: white;
      padding: 15px 20px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
    }

    main {
      padding: 30px 20px;
      max-width: 800px;
      margin: 0 auto;
    }

    h2 {
      color: #1abc9c;
      text-align: center;
      margin-bottom: 30px;
    }

    form {
      background-color: white;
      padding: 25px 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .question-block {
      margin-bottom: 25px;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      position: relative;
      background-color: #fafafa;
    }

    .question-block label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    .question-block textarea,
    .question-block input[type="text"],
    .question-block select {
      width: 100%;
      padding: 10px 14px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 15px;
      box-sizing: border-box;
    }

    .question-block textarea {
      resize: vertical;
    }

    .options-container {
      margin-bottom: 15px;
    }

    button {
      padding: 12px 20px;
      font-size: 1rem;
      background-color: #1abc9c;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 700;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    button:hover {
      background-color: #159a85;
    }

    .add-question-btn {
      background-color: #2980b9;
      margin-top: 10px;
      display: inline-block;
    }

    .add-question-btn:hover {
      background-color: #2471a3;
    }

    .delete-question-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background-color: #e74c3c;
      font-size: 0.9rem;
      padding: 5px 10px;
      border-radius: 4px;
      color: white;
    }

    .delete-question-btn:hover {
      background-color: #c0392b;
    }
  </style>
</head>
<body>

  <header>Create & Publish Questions</header>

  <main>
    <h2>Add Questions to Test</h2>

    <form id="questionsForm">
      <!-- Question blocks go here -->

      <button type="button" class="add-question-btn" onclick="addQuestion()">+ Add Another Question</button>
      <br /><br />
      <button type="submit">Review Questions</button>
    </form>
  </main>

  <script>
    let questionCount = 0;

    function addQuestion() {
      questionCount++;
      const form = document.getElementById('questionsForm');

      const block = document.createElement('div');
      block.classList.add('question-block');
      block.dataset.questionId = questionCount;

      block.innerHTML = `
        <button type="button" class="delete-question-btn" aria-label="Delete Question ${questionCount}" onclick="deleteQuestion(${questionCount})">Delete</button>

        <label for="question${questionCount}">Question ${questionCount}</label>
        <textarea id="question${questionCount}" name="question${questionCount}" rows="3" required placeholder="Enter question text"></textarea>

        <label for="type${questionCount}">Question Type</label>
        <select name="type${questionCount}" id="type${questionCount}" required onchange="toggleQuestionType(${questionCount})">
          <option value="" disabled selected>Select question type</option>
          <option value="objective">Objective (MCQ)</option>
          <option value="descriptive">Descriptive</option>
        </select>

        <div class="options-container" id="optionsContainer${questionCount}" style="display:none;">
          <label>Options</label>
          <input type="text" name="option${questionCount}_1" placeholder="Option A" />
          <input type="text" name="option${questionCount}_2" placeholder="Option B" />
          <input type="text" name="option${questionCount}_3" placeholder="Option C" />
          <input type="text" name="option${questionCount}_4" placeholder="Option D" />

          <label for="answer${questionCount}">Correct Answer</label>
          <select name="answer${questionCount}" id="answer${questionCount}">
            <option value="" disabled selected>Select correct option</option>
            <option value="A">Option A</option>
            <option value="B">Option B</option>
            <option value="C">Option C</option>
            <option value="D">Option D</option>
          </select>
        </div>

        <div class="descriptive-container" id="descriptiveContainer${questionCount}" style="display:none;">
          <label for="descriptiveAnswer${questionCount}">Descriptive Answer</label>
          <textarea name="descriptiveAnswer${questionCount}" id="descriptiveAnswer${questionCount}" rows="3" placeholder="Enter descriptive answer"></textarea>
        </div>
      `;

      // Insert the new question block before the add question button
      const addBtn = form.querySelector('.add-question-btn');
      form.insertBefore(block, addBtn);
    }

    function toggleQuestionType(questionId) {
      const typeSelect = document.getElementById(`type${questionId}`);
      const optionsDiv = document.getElementById(`optionsContainer${questionId}`);
      const descriptiveDiv = document.getElementById(`descriptiveContainer${questionId}`);

      if (typeSelect.value === 'objective') {
        optionsDiv.style.display = 'block';
        descriptiveDiv.style.display = 'none';

        // Make options and answer required
        [...optionsDiv.querySelectorAll('input')].forEach(input => input.required = true);
        optionsDiv.querySelector('select').required = true;

        // Remove required from descriptive answer
        descriptiveDiv.querySelector('textarea').required = false;
      } else if (typeSelect.value === 'descriptive') {
        optionsDiv.style.display = 'none';
        descriptiveDiv.style.display = 'block';

        // Make descriptive answer required
        descriptiveDiv.querySelector('textarea').required = true;

        // Remove required from options and answer
        [...optionsDiv.querySelectorAll('input')].forEach(input => input.required = false);
        optionsDiv.querySelector('select').required = false;
      } else {
        optionsDiv.style.display = 'none';
        descriptiveDiv.style.display = 'none';

        // Remove all required attributes
        [...optionsDiv.querySelectorAll('input')].forEach(input => input.required = false);
        optionsDiv.querySelector('select').required = false;
        descriptiveDiv.querySelector('textarea').required = false;
      }
    }

    function deleteQuestion(questionId) {
      const block = document.querySelector(`.question-block[data-question-id="${questionId}"]`);
      if (block) {
        block.remove();
        renumberQuestions();
      }
    }

    function renumberQuestions() {
      const blocks = document.querySelectorAll('.question-block');
      questionCount = blocks.length;

      blocks.forEach((block, index) => {
        const newId = index + 1; // numbering from 1

        block.dataset.questionId = newId;

        // Update label text and 'for' attributes
        const label = block.querySelector('label[for^="question"]');
        label.setAttribute('for', `question${newId}`);
        label.textContent = `Question ${newId}`;

        // Update question textarea id and name
        const textarea = block.querySelector('textarea[id^="question"]');
        textarea.id = `question${newId}`;
        textarea.name = `question${newId}`;

        // Update question type select id, name and onchange handler
        const typeSelect = block.querySelector('select[id^="type"]');
        typeSelect.id = `type${newId}`;
        typeSelect.name = `type${newId}`;
        typeSelect.setAttribute('onchange', `toggleQuestionType(${newId})`);

        // Update options container id
        const optionsDiv = block.querySelector('.options-container');
        optionsDiv.id = `optionsContainer${newId}`;

        // Update each option input name and placeholder
        const optionInputs = optionsDiv.querySelectorAll('input[type="text"]');
        optionInputs.forEach((input, idx) => {
          const optionLetter = String.fromCharCode(65 + idx); // A, B, C, D
          input.name = `option${newId}_${idx + 1}`;
          input.placeholder = `Option ${optionLetter}`;
        });

        // Update correct answer select id and name
        const answerSelect = optionsDiv.querySelector('select');
        answerSelect.id = `answer${newId}`;
        answerSelect.name = `answer${newId}`;

        // Update descriptive container id
        const descriptiveDiv = block.querySelector('.descriptive-container');
        descriptiveDiv.id = `descriptiveContainer${newId}`;

        // Update descriptive answer textarea id and name
        const descTextarea = descriptiveDiv.querySelector('textarea');
        descTextarea.id = `descriptiveAnswer${newId}`;
        descTextarea.name = `descriptiveAnswer${newId}`;

        // Update delete button onclick and aria-label
        const deleteBtn = block.querySelector('.delete-question-btn');
        deleteBtn.setAttribute('onclick', `deleteQuestion(${newId})`);
        deleteBtn.setAttribute('aria-label', `Delete Question ${newId}`);
      });
    }

    // On form submit, validate and save questions to localStorage then redirect
    document.getElementById('questionsForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const questionBlocks = document.querySelectorAll('.question-block');
      if (questionBlocks.length === 0) {
        alert('Please add at least one question before publishing.');
        return;
      }

      // Collect questions data
      const questions = [];

      for (const block of questionBlocks) {
        const questionText = block.querySelector('textarea[id^="question"]').value.trim();
        if (!questionText) {
          alert('Please fill all question texts.');
          return;
        }

        const typeSelect = block.querySelector('select[name^="type"]');
        if (!typeSelect || !typeSelect.value) {
          alert('Please select question type for all questions.');
          return;
        }

        const questionData = {
          question: questionText,
          type: typeSelect.value,
        };

        if (typeSelect.value === 'objective') {
          const options = [...block.querySelectorAll('.options-container input')];
          if (options.some(opt => !opt.value.trim())) {
            alert('Please fill all options for objective questions.');
            return;
          }

          const answerSelect = block.querySelector('.options-container select');
          if (!answerSelect || !answerSelect.value) {
            alert('Please select correct answer for all objective questions.');
            return;
          }

          questionData.options = options.map(opt => opt.value.trim());
          questionData.answer = answerSelect.value;
        } else if (typeSelect.value === 'descriptive') {
          const descAnswer = block.querySelector('.descriptive-container textarea').value.trim();
          if (!descAnswer) {
            alert('Please fill descriptive answer for all descriptive questions.');
            return;
          }

          questionData.descriptiveAnswer = descAnswer;
        }

        questions.push(questionData);
      }

      // Save questions array to localStorage
      localStorage.setItem('reviewQuestions', JSON.stringify(questions));

      // Redirect to review_questions.html
      window.location.href = 'reveiw_question.html';
    });

    // Add first question on page load
    window.onload = () => {
      addQuestion();
    };
  </script>

</body>
</html>
