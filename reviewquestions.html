<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Review Questions - Faculty Dashboard</title>
  <style>
    body { margin: 0; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background-color: #f4f7f9; }
    header { background-color:#2c3e50; color:white; padding:15px 20px; text-align:center; font-size:1.5rem; font-weight:600; }
    main { padding:30px 20px; max-width:900px; margin:0 auto; }
    h2 { color:#1abc9c; text-align:center; margin-bottom:30px; }
    .question-block { background:white; border-radius:10px; padding:20px; margin-bottom:20px; box-shadow:0 4px 10px rgba(0,0,0,0.1); position:relative; }
    .question-header { font-weight:700; margin-bottom:15px; font-size:1.1rem; color:#333; }
    .options-list { list-style-type:none; padding-left:0; }
    .options-list li { margin-bottom:5px; padding:6px 12px; background:#ecf0f1; border-radius:5px; font-size:0.95rem; }
    .correct-answer { font-weight:700; color:#27ae60; margin-top:10px; }
    button { padding:8px 16px; font-size:0.95rem; background-color:#2980b9; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:700; transition:background-color 0.3s ease; user-select:none; margin-top:15px; }
    button:hover { background-color:#2471a3; }
    textarea,input[type="text"],select { width:100%; font-size:1rem; padding:8px 12px; margin-top:5px; margin-bottom:10px; box-sizing:border-box; border-radius:6px; border:1px solid #ccc; resize:vertical; }

    /* Success Animation Popup */
    #successPopup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(0); background-color:#2ecc71; color:white; padding:20px 30px; border-radius:10px; font-size:1.2rem; box-shadow:0 10px 25px rgba(0,0,0,0.2); text-align:center; z-index:1000; transition: transform 0.3s ease-out; }
    #successPopup.show { transform:translate(-50%,-50%) scale(1); }
    #successPopup::after { content:'âœ”'; display:block; font-size:2rem; margin-top:10px; }
  </style>
</head>
<body>

<header>Review & Edit Questions</header>

<main>
  <h2>Review Your Questions</h2>
  <div id="questionsContainer"></div>
  <button onclick="saveAll()">Save All Changes</button>
  <button onclick="goBack()" style="margin-left:15px;background-color:#1abc9c;">Back to Create Questions</button>
</main>

<div id="successPopup">Saved Successfully</div>

<script>
let questions = [];
let test_id = localStorage.getItem('current_test_id'); // Get test_id from previous step

if(!test_id){
  alert('Test ID not found. Redirecting to create test page.');
  window.location.href = 'create-test.html';
}

// Fetch questions from database
function loadQuestions(){
  fetch('fetch_questions.php?test_id=' + test_id)
    .then(res => res.json())
    .then(data => {
      if(data.status==='success'){
        questions = data.questions;
        renderQuestions();
      } else {
        alert('No questions found. Redirecting to create questions page.');
        window.location.href = 'creating_test.html';
      }
    })
    .catch(err => {
      alert('Error fetching questions: '+err);
      window.location.href = 'creating_test.html';
    });
}

function renderQuestions(){
  const container = document.getElementById('questionsContainer');
  container.innerHTML = '';

  questions.forEach((q,index)=>{
    const block = document.createElement('div');
    block.className = 'question-block';
    block.dataset.index = index;

    block.innerHTML = `
      <div class="question-header">Question ${index+1}</div>
      <label><strong>Question Text:</strong></label>
      <textarea rows="3" class="question-textarea" disabled>${q.question_text}</textarea>

      <label><strong>Question Type:</strong></label>
      <select class="type-select" disabled>
        <option value="objective" ${q.type==='objective'?'selected':''}>Objective (MCQ)</option>
        <option value="descriptive" ${q.type==='descriptive'?'selected':''}>Descriptive</option>
      </select>
    `;

    if(q.type==='objective'){
      let optionsHtml = '<ul class="options-list">';
      ['option_a','option_b','option_c','option_d'].forEach((optKey,i)=>{
        const letter = String.fromCharCode(65+i);
        optionsHtml += `<li>
          <label>Option ${letter}:</label>
          <input type="text" class="option-input" data-option-index="${i}" value="${q[optKey]||''}" disabled />
        </li>`;
      });
      optionsHtml += '</ul>';
      block.innerHTML += optionsHtml;
      const correctAnswerLabel = document.createElement('div');
      correctAnswerLabel.className = 'correct-answer';
      correctAnswerLabel.textContent = `Correct Answer: Option ${q.correct_answer || 'A'}`;
      block.appendChild(correctAnswerLabel);
    } else if(q.type==='descriptive'){
      block.innerHTML += `
        <label><strong>Descriptive Answer:</strong></label>
        <textarea class="descriptive-answer" rows="3" disabled>${q.descriptive_answer||''}</textarea>
      `;
    }

    const editBtn = document.createElement('button');
    editBtn.textContent = 'Edit';
    editBtn.onclick = ()=>toggleEdit(index,block);
    block.appendChild(editBtn);

    container.appendChild(block);
  });
}

function toggleEdit(index, block){
  const questionTextarea = block.querySelector('.question-textarea');
  const typeSelect = block.querySelector('.type-select');
  const optionInputs = block.querySelectorAll('.option-input');
  const descriptiveAnswer = block.querySelector('.descriptive-answer');
  const editBtn = block.querySelector('button');

  if(editBtn.textContent==='Edit'){
    questionTextarea.disabled=false;
    typeSelect.disabled=false;
    if(questions[index].type==='objective') optionInputs.forEach(i=>i.disabled=false);
    if(questions[index].type==='descriptive') descriptiveAnswer.disabled=false;
    editBtn.textContent='Save';
  } else {
    if(!questionTextarea.value.trim()){ alert('Question text cannot be empty.'); return; }
    const newType = typeSelect.value;
    if(!newType){ alert('Select question type.'); return; }

    if(newType==='objective'){
      for(const input of optionInputs){ if(!input.value.trim()){ alert('All options must be filled.'); return; } }
      questions[index].question_text=questionTextarea.value.trim();
      questions[index].type=newType;
      ['option_a','option_b','option_c','option_d'].forEach((key,i)=>questions[index][key]=optionInputs[i].value.trim());
      questions[index].correct_answer = questions[index].correct_answer || 'A';
      delete questions[index].descriptive_answer;
    } else if(newType==='descriptive'){
      if(!descriptiveAnswer.value.trim()){ alert('Answer cannot be empty.'); return; }
      questions[index].question_text=questionTextarea.value.trim();
      questions[index].type=newType;
      questions[index].descriptive_answer=descriptiveAnswer.value.trim();
      delete questions[index].option_a; delete questions[index].option_b; delete questions[index].option_c; delete questions[index].option_d; delete questions[index].correct_answer;
    }

    questionTextarea.disabled=true;
    typeSelect.disabled=true;
    optionInputs.forEach(i=>i.disabled=true);
    if(descriptiveAnswer) descriptiveAnswer.disabled=true;
    editBtn.textContent='Edit';
    alert('Question updated successfully.');
  }
}

function saveAll(){
  fetch('update_questions.php',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({test_id, questions})
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.status==='success') showSuccessPopup();
    else alert('Error saving questions: '+data.message);
  })
  .catch(err=>alert('Error: '+err));
}

function goBack(){ window.location.href='creating_test.html'; }

function showSuccessPopup(){
  const popup=document.getElementById('successPopup');
  popup.classList.add('show');
  setTimeout(()=>{ popup.classList.remove('show'); },2000);
}

window.onload = loadQuestions;
</script>

</body>
</html>
